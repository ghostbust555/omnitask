<!DOCTYPE html>
<html lang="en">
	<head>
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
		<meta charset="utf-8" />
		<title>Dashboard - Ace Admin</title>

		<meta name="description" content="overview &amp; stats" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />

		<!-- bootstrap & fontawesome -->
		<link rel="stylesheet" href="assets/css/bootstrap.min.css" />
		<link rel="stylesheet" href="assets/font-awesome/4.5.0/css/font-awesome.min.css" />

		<!-- page specific plugin styles -->

		<!-- text fonts -->
		<link rel="stylesheet" href="assets/css/fonts.googleapis.com.css" />

		<!-- ace styles -->
		<link rel="stylesheet" href="assets/css/ace.min.css" class="ace-main-stylesheet" id="main-ace-style" />

		<!--[if lte IE 9]>
			<link rel="stylesheet" href="assets/css/ace-part2.min.css" class="ace-main-stylesheet" />
		<![endif]-->
		<link rel="stylesheet" href="assets/css/ace-skins.min.css" />
		<link rel="stylesheet" href="assets/css/ace-rtl.min.css" />

		<!--[if lte IE 9]>
		  <link rel="stylesheet" href="assets/css/ace-ie.min.css" />
		<![endif]-->

		<!-- inline styles related to this page -->

		<!-- ace settings handler -->
		<script src="assets/js/ace-extra.min.js"></script>

		<!-- HTML5shiv and Respond.js for IE8 to support HTML5 elements and media queries -->

		<!--[if lte IE 8]>
		<script src="assets/js/html5shiv.min.js"></script>
		<script src="assets/js/respond.min.js"></script>
		<![endif]-->

        <style>
            .modal-dialog {
                 width: 80% !important;;
            }
        </style>
	</head>

	<body class="no-skin">
		<div id="navbar" class="navbar navbar-default          ace-save-state">
			<div class="navbar-container ace-save-state" id="navbar-container">
				<button type="button" class="navbar-toggle menu-toggler pull-left" id="menu-toggler" data-target="#sidebar">
					<span class="sr-only">Toggle sidebar</span>

					<span class="icon-bar"></span>

					<span class="icon-bar"></span>

					<span class="icon-bar"></span>
				</button>

				<div class="navbar-header pull-left">
					<a href="index.html" class="navbar-brand">
						<small>
							<i class="fa fa-th-list"></i>
							OmniTasks Admin
						</small>
					</a>
				</div>

				<div class="navbar-buttons navbar-header pull-right" role="navigation">
					<ul class="nav ace-nav">
					</ul>
				</div>
			</div><!-- /.navbar-container -->
		</div>

		<div class="main-container ace-save-state" id="main-container" style="overflow-x: hidden;">
			<script type="text/javascript">
				try{ace.settings.loadState('main-container')}catch(e){}
			</script>

			<div id="sidebar" class="sidebar                  responsive                    ace-save-state">
				<script type="text/javascript">
					try{ace.settings.loadState('sidebar')}catch(e){}
				</script>

				<!--<div class="sidebar-shortcuts" id="sidebar-shortcuts">-->
					<!--<div class="sidebar-shortcuts-large" id="sidebar-shortcuts-large">-->
						<!--<button class="btn btn-success">-->
							<!--<i class="ace-icon fa fa-signal"></i>-->
						<!--</button>-->

						<!--<button class="btn btn-info">-->
							<!--<i class="ace-icon fa fa-pencil"></i>-->
						<!--</button>-->

						<!--<button class="btn btn-warning">-->
							<!--<i class="ace-icon fa fa-users"></i>-->
						<!--</button>-->

						<!--<button class="btn btn-danger">-->
							<!--<i class="ace-icon fa fa-cogs"></i>-->
						<!--</button>-->
					<!--</div>-->

					<!--<div class="sidebar-shortcuts-mini" id="sidebar-shortcuts-mini">-->
						<!--<span class="btn btn-success"></span>-->

						<!--<span class="btn btn-info"></span>-->

						<!--<span class="btn btn-warning"></span>-->

						<!--<span class="btn btn-danger"></span>-->
					<!--</div>-->
				<!--</div>&lt;!&ndash; /.sidebar-shortcuts &ndash;&gt;-->

				<ul class="nav nav-list">
					<li class="active">
						<a href="index.html">
							<i class="menu-icon fa fa-tachometer"></i>
							<span class="menu-text"> Dashboard </span>
						</a>

						<b class="arrow"></b>
					</li>

					<li class="">
						<a href="tensorboard.html">
							<i class="menu-icon fa fa-desktop"></i>
							<span class="menu-text">
								TensorBoard
							</span>
						</a>

						<b class="arrow"></b>
					</li>
				</ul><!-- /.nav-list -->

				<div class="sidebar-toggle sidebar-collapse" id="sidebar-collapse">
					<i id="sidebar-toggle-icon" class="ace-icon fa fa-angle-double-left ace-save-state" data-icon1="ace-icon fa fa-angle-double-left" data-icon2="ace-icon fa fa-angle-double-right"></i>
				</div>
			</div>

			<div class="main-content">
				<div class="main-content-inner">
					<div class="breadcrumbs ace-save-state" id="breadcrumbs">
						<ul class="breadcrumb">
							<li>
								<i class="ace-icon fa fa-home home-icon"></i>
								<a href="#">Home</a>
							</li>
							<li class="active">Dashboard</li>
						</ul><!-- /.breadcrumb -->
					</div>

					<div class="page-content">
						<div class="page-header">
							<h1>
								Dashboard
								<small>
									<i class="ace-icon fa fa-angle-double-right"></i>
									overview &amp; stats
								</small>
							</h1>
						</div><!-- /.page-header -->

						<div class="row">
							<div class="col-xs-12">
								<!-- PAGE CONTENT BEGINS -->

								<div class="row">
									<div class="col-xs-12 col-sm-12 widget-container-col ui-sortable" id="widget-container-col-1">
										<div class="widget-box ui-sortable-handle" id="widget-box-1">
											<div class="widget-header">
												<h5 class="widget-title">Add A Job</h5>

												<div class="widget-toolbar">
													<a href="#" data-action="fullscreen" class="orange2">
														<i class="ace-icon fa fa-expand"></i>
													</a>

													<a href="#" data-action="collapse">
														<i class="ace-icon fa fa-chevron-up"></i>
													</a>
												</div>
											</div>

											<div class="widget-body">
												<div class="widget-main">
													<div class="form-horizontal" role="form">
														<div class="form-group">
															<!--<label class="col-sm-3 control-label no-padding-right no-padding-left" for="form-field-1"> Git Repo </label>-->

															<div class="col-sm-12">
																<input type="text" id="git-repo-form-field" placeholder="Repo Path" class="col-sm-4" tabindex="1">
																<input type="text" id="git-branch-form-field" placeholder="Git Branch" class="col-sm-4" tabindex="2">
																<input type="text" id="job-tag-form-field" placeholder="Job Tag" class="col-sm-4" tabindex="3">
															</div>
                                                            <div class="col-sm-12" style="margin-top:5px">
																<input type="text" id="source-form-field" placeholder="Source File" class="col-sm-6" tabindex="4">
																<input type="text" id="parameters-form-field" placeholder="Parameters" class="col-sm-6" tabindex="5">
                                                            </div>

															<div class="col-sm-3 pull-right" style="margin-top: 1em">
																<button id="job-submit-button" class="btn btn-white btn-default btn-round col-sm-6">
																	<i class="ace-icon fa fa-arrow-circle-up bigger-120 blue"></i>
																	Submit
																</button>
																<button id = "job-cancel-button" class="btn btn-white btn-default btn-round col-sm-6">
																	<i class="ace-icon fa fa-times red2"></i>
																	Cancel
																</button>
															</div>
														</div>
													</div>
												</div>
											</div>
										</div>
									</div>
								</div><!-- /.row -->
								<!-- PAGE CONTENT ENDS -->
							</div><!-- /.col -->

						</div><!-- /.row -->

						<div class="row">
							<div class="col-xs-12 col-sm-12 widget-container-col ui-sortable">
								<div class="widget-box ui-sortable-handle">
									<div class="widget-header">
										<h5 class="widget-title">Jobs List</h5>

										<div class="widget-toolbar">
											<a href="#" data-action="fullscreen" class="orange2">
												<i class="ace-icon fa fa-expand"></i>
											</a>

											<a href="#" id="jobs-table-refresh-button" data-action="reload">
												<i class="ace-icon fa fa-refresh"></i>
											</a>

											<a href="#" data-action="collapse">
												<i class="ace-icon fa fa-chevron-up"></i>
											</a>
										</div>
									</div>

									<div class="widget-body">
										<div class="widget-main">
											<div id="jobs-table" style=""></div>
										</div>
									</div>
								</div>
							</div>
						</div>

						<div class="row">
							<div class="col-xs-12 col-sm-12 widget-container-col ui-sortable">
								<div class="widget-box ui-sortable-handle">
									<div class="widget-header">
										<h5 class="widget-title">Machine State</h5>

										<div class="widget-toolbar">
											<a href="#" data-action="fullscreen" class="orange2">
												<i class="ace-icon fa fa-expand"></i>
											</a>

											<a href="#" data-action="collapse">
												<i class="ace-icon fa fa-chevron-up"></i>
											</a>
										</div>
									</div>

									<div class="widget-body">
										<div class="widget-main">
											<div id="machine-state-line-graph" class="dynamicsparkline" style="width:100%;height:220px;margin-left:12px;margin-right:12px"></div>
											</div>
										</div>
									</div>
								</div>
						</div>
					</div><!-- /.page-content -->
				</div>
			</div><!-- /.main-content -->

			<a href="#" id="btn-scroll-up" class="btn-scroll-up btn btn-sm btn-inverse">
				<i class="ace-icon fa fa-angle-double-up icon-only bigger-110"></i>
			</a>
		</div><!-- /.main-container -->

		<!-- basic scripts -->

		<!--[if !IE]> -->
		<script src="assets/js/jquery-2.1.4.min.js"></script>

		<!-- <![endif]-->

		<!--[if IE]>
<script src="assets/js/jquery-1.11.3.min.js"></script>
<![endif]-->
		<script type="text/javascript">
			if('ontouchstart' in document.documentElement) document.write("<script src='assets/js/jquery.mobile.custom.min.js'>"+"<"+"/script>");
		</script>
		<script src="assets/js/bootstrap.min.js"></script>

		<!-- page specific plugin scripts -->

		<!--[if lte IE 8]>
		  <script src="assets/js/excanvas.min.js"></script>
		<![endif]-->
		<script src="assets/js/jquery-ui.min.js"></script>
		<script src="assets/js/jquery-ui.custom.min.js"></script>
		<script src="assets/js/jquery.ui.touch-punch.min.js"></script>
		<script src="assets/js/jquery.easypiechart.min.js"></script>
		<script src="assets/js/jquery.sparkline.index.min.js"></script>
		<script src="assets/js/jquery.flot.min.js"></script>
		<script src="assets/js/jquery.flot.pie.min.js"></script>
		<script src="assets/js/jquery.flot.resize.min.js"></script>
		<script src="assets/js/jquery.flot.time.js"></script>

        <link rel="stylesheet" href="assets/css/jquery.gritter.min.css">
        <script src="assets/js/jquery.gritter.min.js"></script>

        <script src="assets/js/bootbox.js"></script>

		<link href="https://cdnjs.cloudflare.com/ajax/libs/tabulator/3.5.2/css/tabulator.min.css" rel="stylesheet">
		<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/tabulator/3.5.2/js/tabulator.min.js"></script>

		<!-- ace scripts -->
		<script src="assets/js/ace-elements.min.js"></script>
		<script src="assets/js/ace.min.js"></script>

		<!-- inline scripts related to this page -->
		<script type="text/javascript">
			$(document).ready( function () {
				var cpu = [];
				var memory = [];

				var updateMachineStatePlot = function(){
					$.plot("#machine-state-line-graph", [
						{ label: "Free Memory Gb", data: memory, yaxis: 2 },
						{ label: "Cpu Utilization %", data: cpu }
					], {
						hoverable: true,
						series: {
							lines: {
								show: true,
								lineWidth: 1.2,
								fill: true
							}
						},
						xaxis: {
							mode: "time",
							tickSize: [5, "second"],
							tickFormatter: function (v, axis) {
								var date = new Date(v);

								if (date.getSeconds() % 20 == 0) {
									var hours = date.getHours() < 10 ? "0" + date.getHours() : date.getHours();
									var minutes = date.getMinutes() < 10 ? "0" + date.getMinutes() : date.getMinutes();
									var seconds = date.getSeconds() < 10 ? "0" + date.getSeconds() : date.getSeconds();

									return hours + ":" + minutes + ":" + seconds;
								} else {
									return "";
								}
							},
							axisLabel: "Time",
							axisLabelUseCanvas: true,
							axisLabelFontSizePixels: 12,
							axisLabelFontFamily: 'Verdana, Arial',
							axisLabelPadding: 10
						},
						yaxes: [{
							min: 0,
							max: 100,
							tickSize: 5,
							tickFormatter: function (v, axis) {
								if (v % 10 == 0) {
									return v + "%";
								} else {
									return "";
								}
							},
							axisLabel: "CPU loading",
							axisLabelUseCanvas: true,
							axisLabelFontSizePixels: 12,
							axisLabelFontFamily: 'Verdana, Arial',
							axisLabelPadding: 6
						},{ min: 0 }],
						legend: {
							labelBoxBorderColor: "#fff",
							backgroundColor: "#fff"
						},
						grid: {
							backgroundColor: "#000000",
							tickColor: "#008040"
						}
					});
				}

				updateMachineStatePlot();

				setInterval(function(){
					$.get("/getMachineState").done(function(data){
						cpu.push([new Date().getTime(), data.CPU]);
						memory.push([new Date().getTime(), data.Memory/1024]);

						if(cpu.length > 60){
							cpu.shift();
						}

						if(memory.length > 60){
							memory.shift();
						}

						updateMachineStatePlot();
					});
				}, 5000);

                $("#git-repo-form-field").focusin(function(){
                    $("#git-repo-form-field").css("border", "")
                });

                $("#git-repo-form-field").focusout(function(){
                    $.get("/getGitBranches", {"gitRepo":$("#git-repo-form-field").val()}).done(function(data){
                        $( "#git-branch-form-field" ).autocomplete({
                            source: data.Branches
                        });
					}).fail(function(data){
                        $("#git-repo-form-field").css("border", "solid thin red");
					});
                });

				$('#job-submit-button').click(function(){
					$.get( "/addJob", {
							gitRepo:$("#git-repo-form-field").val(),
							gitBranch:$("#git-branch-form-field").val(),
							src:$("#source-form-field").val(),
							parameters:$("#parameters-form-field").val(),
							tag:$("#job-tag-form-field").val()
						}).done(function( data ) {
							$("#jobs-table").tabulator("setData", "/getJobs");
						}
					);
				});

				var statusFormatter = function(value, data, cell, row, options, formatterParams){
					//value - value of the cell
					//data - data for the row the cell is in
					//cell - DOM element of the cell
					//row - DOM element of the row
					//options - options set for this tabulator
					//formatterParams - parameters set for the column

					if(value.cell.value == 0 || value.cell.value == "Complete"){
						return "<i class=\"fa fa-check-circle green\"></i>"; // must return the HTML or jQuery element for the contents of the cell;
					}else if(value.cell.value == "Pending"){
						return "<i class=\"fa fa-calendar blue\"></i>";
					}else if(value.cell.value == "Active"){
						return "<i class=\"fa fa-spinner fa-spin green\"></i>";
					}else if(value.cell.value == "GitFailed"){
						return "<i class=\"fa fa-git red\"></i>";
					}else{
						return "<i class=\"fa fa-times-circle red\"></i>"; // must return the HTML or jQuery element for the contents of the cell;
					}
				}

				var showJobModal = function(jobId, data, buttonMessage, confirmMessage, confirmTitle){
				    var dynButtons = {
                        cancel: {
                            label: "Close",
                            className: 'btn-info',
                            callback: function(){

                            }
                        }
                    };

				    if(buttonMessage != null)
				    {
                        dynButtons = {
                            stopJob: {
                                label: buttonMessage,
                                className: 'btn-danger',
                                callback: function(){
                                    bootbox.confirm({
                                        title: confirmTitle,
                                        message: confirmMessage,
                                        buttons: {
                                            cancel: {
                                                label: '<i class="fa fa-times"></i> Cancel'
                                            },
                                            confirm: {
                                                label: '<i class="fa fa-check"></i> '+buttonMessage,
                                                className: 'btn-danger'
                                            }
                                        },
                                        callback: function (result) {
                                            if(result == true){
                                                $.get("/stopJob", {"jobId":jobId}).done(function(stopJobResult){
                                                    $.gritter.add({
                                                        title:buttonMessage+" Succeeded",
                                                        text:"Job "+jobId+" was stopped or removed successfully",
                                                        class_name:"gritter-info"
                                                    });
                                                }).fail(function(stopJobFailure){
                                                    $.gritter.add({
                                                        title:buttonMessage+" Failed",
                                                        text:stopJobFailure.responseText,
                                                        class_name:"gritter-error"
                                                    });
                                                });
                                            }else{
                                                showJobModal(data, buttonMessage, confirmMessage, confirmTitle);
                                            }
                                        }
                                    });
                                }
                            },
                            cancel: {
                                label: "Close",
                                className: 'btn-info'
                            }
                        }
                    }

				    bootbox.dialog(
                    {
                        title: "Job Logs For Job "+jobId,
                        message:
                                 '<div class="red" style="max-height:400px;overflow-y:auto;word-wrap: break-word;margin:10px;border: thin lightgray solid;border-radius: 5px;padding: 5px;">'+data.StdErr+'</div>' +
                                 '<div class="" style="max-height:400px;overflow-y:auto;word-wrap: break-word;margin:10px;border: thin lightgray solid;border-radius: 5px;padding: 5px;">'+data.StdOut+'</div>',
                        onEscape:true,
                        size:"Large",
                        buttons: dynButtons
                    });
				}

				$('#jobs-table').tabulator({
					height:350, // set height of table (in CSS or here), this enables the Virtual DOM and improves render speed dramatically (can be any valid css height value)
					layout:"fitColumns", //fit columns to width of table (optional)
					columns:[ //Define Table Columns
						{title:"ID", field:"JobId", width:50, sorter:"number"},
						{title:"Git Repo", field:"GitRepo", sortable:"true"},
						{title:"Branch", field:"GitBranch", sortable:"true"},
						{title:"Tag", field:"Tag", sortable:"true"},
						{title:"Src File", field:"Src", sortable:"true"},
						{title:"Parameters", field:"Parameters", sortable:"true"},
						{title:"Job Start", field:"Start", sortable:"true"}, //sorter:"date"
						{title:"Job Stop", field:"Stop", sortable:"true"},
						{title:"Status", field:"Status", formatter:statusFormatter, width:50, sortable:"true"},
					],
					rowClick:function(e, row){ //trigger an alert message when the row is clicked
                        var pending = row.getData().Status == "Pending";
                        var active = row.getData().Status == "Active";

					    $.get("/getJobOutput", {"jobId":row.getData().JobId}).done(function(data){
					        if(pending){
                                showJobModal(row.getData().JobId, data, "Remove Job", "Mark Job as Removed?", "Are you sure you want to remove this job? This cannot be undone.");
                            }else if(active){
                                showJobModal(row.getData().JobId, data, "Stop Job", "Stop Running Job?", "Are you sure you want to stop this job? This cannot be undone.");
                            }else{
                                showJobModal(row.getData().JobId, data, null, null, null);
                            }

					    });
					},
					initialSort:[
						{column:"JobId", dir:"desc"}, //sort by this first
    				]
				});

				$("#jobs-table").tabulator("setData", "/getJobs");

				setInterval(function(){
					$("#jobs-table").tabulator("setData", "/getJobs");
				}, 30000);

				$("#jobs-table-refresh-button").click(function(){
					$("#jobs-table").tabulator("setData", "/getJobs");
				});

			} );
		</script>
	</body>
</html>
